# SiYuan Whiteboard Plugin 项目架构分析文档

## 项目概述

SiYuan Whiteboard Plugin 是一个基于 Tldraw 的思源笔记白板插件，提供了在思源笔记中创建和管理白板的功能。该插件支持多语言，具有完整的白板管理界面和自定义形状功能。

### 基本信息
- **项目名称**: siyuan-plugin-whiteboard
- **版本**: 0.2.4
- **作者**: zuoez02
- **许可证**: MIT
- **核心依赖**: Tldraw 3.15.3, React 18.2.0

## 技术栈

### 前端技术
- **React 18.2.0**: 主要UI框架
- **TypeScript**: 类型安全的JavaScript超集
- **Tldraw 2.0.0-beta.2**: 核心白板绘图库
- **Sass**: CSS预处理器

### 构建工具
- **Vite 4.3.7**: 现代化构建工具
- **ESLint**: 代码质量检查
- **TypeScript Compiler**: 类型检查和编译

### 插件系统
- **SiYuan Plugin API**: 思源笔记插件接口
- **SiYuan 0.9.0**: 思源笔记SDK

## 项目结构

```
src/
├── api.ts                    # SiYuan API 封装
├── index.ts                  # 插件主入口
├── index.scss               # 全局样式
├── assets/                  # 静态资源
│   └── icon.ts             # 图标定义
├── components/              # React 组件
│   ├── dialog-content.tsx  # 对话框内容组件
│   ├── dock.tsx           # 侧边栏组件
│   └── tab.tsx            # 标签页组件
├── i18n/                   # 国际化文件
│   ├── en_US.json         # 英文
│   ├── es_ES.json         # 西班牙文
│   └── zh_CN.json         # 中文
├── services/               # 业务逻辑层
│   └── data.ts            # 数据管理服务
├── types/                  # 类型定义
│   ├── api.d.ts           # API类型定义
│   └── index.d.ts         # 通用类型定义
├── utils/                  # 工具函数
│   ├── dialog.ts          # 对话框工具
│   ├── env.ts             # 环境变量
│   └── index.ts           # 通用工具
└── whiteboard/             # 白板核心功能
    ├── index.tsx          # 白板主组件
    ├── ui-overrides.ts    # UI覆盖配置
    ├── components/        # 白板组件
    │   ├── siyuan-link-card.tsx
    │   └── siyuan-doc-card.tsx
    └── shapes/            # 自定义形状
        ├── CardShape/     # 卡片形状
        ├── LinkDoc/       # 文档链接形状
        └── LinkText/      # 文本链接形状
```

## 核心架构

### 1. 插件主类 (WhiteboardPlugin)

```typescript
export default class WhiteboardPlugin extends Plugin {
    tab: any;
    tabs: any[];
    
    onload() {
        // 初始化插件
        // 注册图标
        // 初始化侧边栏和标签页
        // 监听事件
    }
    
    open(name) {
        // 打开白板标签页
    }
    
    closeTab(name) {
        // 关闭白板标签页
    }
}
```

### 2. 数据管理层 (services/data.ts)

负责白板数据的持久化存储：

- **存储路径**: `/data/storage/petal/siyuan-plugin-whiteboard/`
- **文件格式**: `.whiteboard` (JSON格式)
- **核心功能**:
  - `saveData()`: 保存白板数据
  - `loadData()`: 加载白板数据
  - `deleteData()`: 删除白板数据
  - `loadAllFiles()`: 获取所有白板文件列表

### 3. 白板组件 (whiteboard/index.tsx)

核心白板功能实现：

```typescript
export const Whiteboard = (props) => {
  const [editor, setEditor] = useState<Editor>(null);
  
  // Tldraw配置
  const assetUrls = getAssetUrls({
    baseUrl: "/plugins/siyuan-plugin-whiteboard/assets/",
  });
  
  // 自定义内容处理器
  e.registerExternalContentHandler("text", ({ type, point, text }) => {
    // 处理思源笔记链接格式
    // {{select * from blocks where id='...'}}
    // ((id 'text'))
  });
}
```

### 4. 自定义形状系统

插件扩展了Tldraw的形状系统，添加了思源笔记特有的形状：

#### LinkDoc 形状
- **用途**: 显示文档链接
- **数据结构**: `{ docId: string }`
- **渲染**: 显示为可点击的文档卡片

#### LinkText 形状  
- **用途**: 显示带文本的链接
- **数据结构**: `{ docId: string, text: string }`
- **渲染**: 显示为带标题的链接卡片

#### CardShape 形状
- **用途**: 通用卡片形状
- **功能**: 可自定义的卡片组件

### 5. UI组件系统

#### Dock组件 (components/dock.tsx)
侧边栏管理界面，提供：
- 白板列表显示
- 创建新白板
- 重命名白板
- 删除白板
- 复制白板链接
- 刷新列表

#### Tab组件 (components/tab.tsx)
标签页容器，负责：
- 渲染白板组件
- 管理白板生命周期

#### DialogContent组件 (components/dialog-content.tsx)
对话框内容，用于：
- 创建白板表单
- 重命名白板表单

## 关键特性

### 1. 思源笔记集成

- **块引用支持**: 支持粘贴思源笔记的块引用和嵌入块
- **文档链接**: 可以创建指向思源文档的链接形状
- **悬浮预览**: 鼠标悬停显示文档预览
- **快速跳转**: 点击链接直接跳转到对应文档

### 2. 数据持久化

- **自动保存**: 编辑时自动保存，防抖延迟500ms
- **JSON格式**: 使用Tldraw原生的JSON快照格式
- **文件管理**: 通过思源API进行文件操作

### 3. 多语言支持

支持三种语言：
- 中文 (zh_CN)
- 英文 (en_US)  
- 西班牙文 (es_ES)

### 4. 自定义UI

- **Shadow DOM**: 使用Shadow DOM隔离样式
- **主题适配**: 适配思源笔记的主题系统
- **响应式设计**: 支持不同屏幕尺寸

## 构建配置

### Vite配置特点

1. **React支持**: 使用@vitejs/plugin-react
2. **静态资源复制**: 自动复制Tldraw资源文件
3. **开发模式**: 支持热重载和实时预览
4. **生产构建**: 自动打包为zip文件
5. **外部依赖**: 排除siyuan和process依赖

### TypeScript配置

- **目标**: ESNext
- **模块系统**: ESNext + Node解析
- **JSX**: react-jsx
- **严格模式**: 部分启用
- **路径别名**: @/* 映射到 src/*

## API封装

### SiYuan API (api.ts)

提供了完整的思源笔记API封装，包括：

- **笔记本操作**: 创建、删除、重命名笔记本
- **文档操作**: 创建、移动、删除文档
- **块操作**: 插入、更新、删除块
- **文件操作**: 上传、下载、删除文件
- **属性操作**: 设置、获取块属性
- **SQL查询**: 执行SQL查询
- **通知系统**: 推送消息和错误

## 开发工作流

### 开发模式
```bash
npm run dev          # 监听模式构建
npm run make-link    # 创建开发链接
```

### 生产构建
```bash
npm run build        # 生产构建并打包
```

### 项目特点

1. **模块化设计**: 清晰的分层架构
2. **类型安全**: 完整的TypeScript类型定义
3. **组件化**: React组件化开发
4. **可扩展性**: 支持自定义形状和工具
5. **国际化**: 完整的多语言支持
6. **集成性**: 深度集成思源笔记功能

## 技术亮点

1. **Shadow DOM隔离**: 避免样式冲突
2. **防抖保存**: 优化性能，避免频繁IO
3. **事件驱动**: 基于思源事件系统
4. **自定义形状**: 扩展Tldraw功能
5. **链接识别**: 智能识别思源链接格式
6. **悬浮预览**: 增强用户体验
7. **现代化架构**: 基于Tldraw 3.x最新技术

## 最新更新 (v0.2.4)

### Tldraw 3.15.3 升级
- 性能显著提升
- 更稳定的API
- 更丰富的功能特性
- 更好的浏览器兼容性

### 技术改进
- 更新了自定义形状API适配
- 优化了代码结构
- 提升了稳定性和性能
- 保持了完整的向后兼容性

这个项目展现了一个成熟的思源笔记插件应该具备的完整架构，从数据层到UI层都有清晰的职责分离，同时充分利用了现代前端技术栈的优势。通过升级到Tldraw 3.x，显著提升了性能和用户体验。